<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../favicon.ico">
  
  <title>Accumulators - MongooseIM</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../custom.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "Accumulators";
    var mkdocs_page_input_path = "developers-guide/accumulators.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> MongooseIM</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">User guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Get-to-know-MongooseIM/">ABCs of MongooseIM</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/MongooseIM-High-level-Architecture/">High-level Architecture</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Features-and-supported-standards/">Features and supported standards</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Getting-started/">Getting started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/release_config/">Release/Installation configuration</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/How-to-build/">How to Build MongooseIM from source code</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/push-notifications/Push-notifications/">How to Set up Push Notifications</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/push-notifications/Push-notifications-client-side/">How to Set up Push Notifications on the client side</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/push-notifications/With-MongoosePush/">How to Set up MongoosePush</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/ICE_tutorial/">How to Set up MongooseICE</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/iOS_tutorial/">How to Build an iOS messaging app</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Jingle-SIP-setup/">How to Set up Jingle/SIP</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Migration Guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/3.1.1_3.2.0/">3.1.1 to 3.2.0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/3.3.0_3.4.0/">3.3.0 to 3.4.0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/3.5.0_3.6.0/">3.5.0 to 3.6.0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/jid-from-mam-muc-script/">MAM MUC migration helper</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Platform</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../Contributions/">Contributions to ecosystem</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Differentiators/">Differentiators</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../History/">History</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Configuration</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../Basic-configuration/">Basic Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Erlang-cookie-security/">Erlang Cookie Security</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Advanced-configuration/">Advanced Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/TLS-hardening/">TLS hardening</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/database-backends-configuration/">Database backends configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/outgoing-connections/">Outgoing connections</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/Modules/">Extension Modules</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/Listener-modules/">Listener Modules</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/acl/">ACL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/Services/">Services</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Authentication methods</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-methods/client-certificate/">Client Certificate</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Authentication backends</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/External-authentication-module/">External Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/HTTP-authentication-module/">HTTP Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/JWT-authentication-module/">JWT Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/LDAP-authentication-module/">LDAP Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/PKI-authentication-module/">PKI Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/Riak-authentication-module/">Riak Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/Dummy-authentication-module/">Dummy Authentication Module</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">MongooseIM open XMPP extensions</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../open-extensions/muc_light/">MUC light</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../open-extensions/token-reconnection/">Token-based reconnection</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">REST API</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../rest-api/Client-frontend/">Client/frontend</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../rest-api/Metrics-backend/">Metrics backend</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../rest-api/Administration-backend/">Administration backend</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Operation and maintenance</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/gdpr-considerations/">GDPR considerations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Cluster-management-considerations/">Cluster management considerations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Cluster-configuration-and-node-management/">Cluster configuration and node management</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Logging-%26-monitoring/">Logging & monitoring</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Reloading-configuration-on-a-running-system/">Reloading configuration on a running system</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Mongoose-metrics/">Metrics</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/System-Metrics-Privacy-Policy/">System Metrics Privacy Policy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/tls-distribution/">Distribution over TLS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/known-issues/">Known issues</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developer's guide</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../Testing-MongooseIM/">Testing MongooseIM</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../logging/">Logging</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Hooks-and-handlers/">Hooks and Handlers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../hooks_description/">Hooks description</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../message_routing/">Stanza routing</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">Accumulators</a>
    <ul class="current">
    <li class="toctree-l2"><a class="reference internal" href="#api">API</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#newnew_acc_params">new(new_acc_params())</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#getters-for-predefined-fields">Getters for predefined fields</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#update_stanzastanza_params-t">update_stanza(stanza_params(), t())</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#access-to-namespaced-fields">Access to namespaced fields</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#stripping">Stripping</a>
    </li>
        </ul>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#main-principles-of-an-accumulator-processing">Main principles of an accumulator processing</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#hooks">Hooks</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#iqs-and-accumulators">IQs and accumulators</a>
    </li>
    <li class="toctree-l2"><a class="reference internal" href="#sample-usage-actual-and-potential">Sample usage, actual and potential</a>
        <ul>
    <li class="toctree-l3"><a class="reference internal" href="#privacy-check">Privacy check</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#tracing">Tracing</a>
    </li>
    <li class="toctree-l3"><a class="reference internal" href="#performance-measurement">Performance measurement</a>
    </li>
        </ul>
    </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../flat_options/">Flat options format</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Moving-to-single-app-project-structure/">Moving to single app project structure</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_amp_developers_guide/">mod_amp development</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_muc_light_developers_guide/">mod_muc_light developers doc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../SCRAM-serialization/">SCRAM serialization format</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../xep_tool/">xep-tool usage</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../OpenSSL-and-FIPS/">FIPS mode</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../Basic-iq-handler/">Basic IQ Handler</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mongoose_wpool/">mongoose_wpool</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Module index</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_adhoc/">mod_adhoc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_amp/">mod_amp</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_auth_token/">mod_auth_token</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_blocking/">mod_blocking</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_bosh/">mod_bosh</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_caps/">mod_caps</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_carboncopy/">mod_carboncopy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_commands/">mod_commands</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_csi/">mod_csi</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_inbox/">mod_inbox</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_disco/">mod_disco</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_global_distrib/">mod_global_distrib</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">mod_event_pusher</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../../modules/mod_event_pusher/">mod_event_pusher</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../modules/mod_event_pusher_http/">HTTP backend</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../modules/mod_event_pusher_push/">Push backend</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../modules/mod_event_pusher_sns/">SNS backend</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../../modules/mod_event_pusher_rabbit/">RabbitMQ backend</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_http_upload/">mod_http_upload</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_jingle_sip/">mod_jingle_sip</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_keystore/">mod_keystore</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_last/">mod_last</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_mam/">mod_mam</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_muc/">mod_muc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_muc_commands/">mod_muc_commands</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_muc_log/">mod_muc_log</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_muc_light/">mod_muc_light</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_muc_light_commands/">mod_muc_light_commands</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_offline/">mod_offline</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_offline_stub/">mod_offline_stub</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_ping/">mod_ping</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_privacy/">mod_privacy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_private/">mod_private</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_pubsub/">mod_pubsub</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_push_service_mongoosepush/">mod_push_service_mongoosepush</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_register/">mod_register</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_revproxy/">mod_revproxy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_roster/">mod_roster</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_shared_roster_ldap/">mod_shared_roster_ldap</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_sic/">mod_sic</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_stream_management/">mod_stream_management</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_time/">mod_time</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_vcard/">mod_vcard</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../modules/mod_version/">mod_version</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">MongooseIM</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Developer's guide &raquo;</li>
        
      
    
    <li>Accumulators</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="accumulators">Accumulators</h1>
<p>XMPP stanza processing starts in the <code>ejabberd_c2s</code> module, which receives the stanza from a socket, or in <code>ejabberd_s2s_in</code> which receives stanzas from federated XMPP clusters.
The stanza is processed and eventually it and/or other messages are sent out, either to the original sender, to another c2s process within the same MongooseIM installation, or to another XMPP server.</p>
<p>At the beginning of the main processing chain an accumulator is created containing following set of keys:</p>
<ul>
<li><code>ref</code> - A unique reference of the acc, useful for tracing.</li>
<li><code>timestamp</code> - An Erlang timestamp retrieved from <code>os:timestamp()</code>.</li>
<li><code>origin_pid</code> - A PID of the process that created the accumulator.</li>
<li><code>origin_location</code> - <code>{Module, Function Line}</code> - A place in the code where the accumulator was created.</li>
<li><code>origin_stanza</code> - Original stanza that triggered the processing (in a binary).</li>
<li><code>lserver</code> - Nameprepped domain of the processing context.</li>
<li><code>stanza</code> - A map with information about the stanza being routed. May be missing in some processing chains (when they are not triggered by a stanza)!</li>
<li><code>element</code> - <code>exml:element()</code> with the current stanza being routed.</li>
<li><code>from_jid</code>, <code>to_jid</code> - <code>jid:jid()</code> with the sender and the recipient.</li>
<li><code>name</code> - A name of the top-level element in <code>element</code>.</li>
<li><code>type</code> - A value of <code>type</code> attribute of the top-level element. If the attribute is missing, this field contains <code>undefined</code>.</li>
<li><code>ref</code> - A reference of routed stanza.</li>
</ul>
<p>It is then passed through all the stages until it reaches the end of its life.
Throughout the process it is the very same accumulator; it is therefore possible to store a value in it on one stage of the processing and retrieve the same value later on.</p>
<p>The main assumption is that whatever MongooseIM does, it is always triggered by a stanza entering the system, with some exceptions, such as a couple of <code>mongooseimctl</code> operations, which create stanza-less accumulators.
The stanza should always be packed into an accumulator and passed on, so that internally every action is performed the same way.</p>
<p>There are three main benefits from this approach:</p>
<p>a) performance - if we need to do something involving inspecting a stanza or more complicated operations (e.g. privacy check) we don't need to do it multiple times on various stages of processing - instead we can do it once and store the result in an accumulator</p>
<p>b) debugging - it is now very easy to produce an exact track record of a stanza</p>
<p>c) simplified implementation of modules which inherently involve multi-stage processing (e.g. <code>mod_amp</code>)</p>
<h2 id="api">API</h2>
<p><code>mongoose_acc</code> module exports <code>t()</code> type which is the accumulator type.</p>
<h3 id="newnew_acc_params"><code>new(new_acc_params())</code></h3>
<p>A constructor for accumulators. <code>new_acc_params()</code> is a map with following supported keys:</p>
<ul>
<li><code>location</code> - Should be a <code>{Module, Function, Line}</code> tuple (may be constructed with <code>?LOCATION</code> macro from <code>mongoose.hrl</code>). Its format is not enforced by the acc logic but Dialyzer will most probably complain about any other type.</li>
<li><code>lserver</code> - Nameprepped domain of a the processing context.</li>
<li><code>element</code> (optional) - If present, it will be used as a source for the <code>stanza</code> map.</li>
<li><code>from_jid</code>, <code>to_jid</code> (optional) - Values used to override <code>from</code> and <code>to</code> attributes of the <code>element</code>, respectively.</li>
</ul>
<p>If <code>element</code> is provided, the sender and recipient JIDs are extracted, either from the element itself, or from <code>to_jid</code> and <code>from_jid</code> parameters.
The call will fail with an exception if it's not possible.</p>
<p>While allowed, stanza-less accumulators usage should be avoided.</p>
<h3 id="getters-for-predefined-fields">Getters for predefined fields</h3>
<ul>
<li><code>ref(t())</code></li>
<li><code>timestamp(t())</code></li>
<li><code>lserver(t())</code></li>
<li><code>element(t())</code></li>
<li><code>stanza_name(t())</code> - Returns <code>name</code> value from <code>stanza</code> map.</li>
<li><code>stanza_type(t())</code> - Returns <code>type</code> value from <code>stanza</code> map.</li>
<li><code>stanza_ref(t())</code> - Returns <code>ref</code> value from <code>stanza</code> map. This is not the same as <code>ref(t())</code>!</li>
</ul>
<h3 id="update_stanzastanza_params-t"><code>update_stanza(stanza_params(), t())</code></h3>
<p>Replaces the whole <code>stanza</code> field in accumulator with params provided in <code>stanza_params()</code>, which is a map of 3 fields: <code>element</code>, <code>from_jid</code>, <code>to_jid</code>.
The same rules apply as in the case of constructor (<code>new/1</code>) but this time <code>element</code> field is <strong>mandatory</strong>.</p>
<h3 id="access-to-namespaced-fields">Access to namespaced fields</h3>
<p>It is possible to store and retrieve any data in the accumulator, that is related to the processing.
There is no scope protection, so every module may access all namespaces and keys inside them.</p>
<ul>
<li><code>set(Namespace :: any(), Key :: any(), Value :: any(), t())</code></li>
<li><code>set_permanent(Namespace :: any(), Key :: any(), Value :: any(), t())</code> - Upserts a field, which won't be removed during <code>strip</code> operation.</li>
<li><code>append(Namespace :: any(), Key :: any(), Value :: any(), t())</code> - In order to use this function, a <code>Namespace:Key</code> field must not exist or must be a list. <code>Value</code> is appended to the end of this list. If <code>Value</code> is a list, then a <code>OldValue ++ Value</code> operation is performed. In other cases <code>OldValue ++ [Value]</code> is used.</li>
<li><code>get(Namespace :: any(), Key :: any(), t())</code> - Returns a value of a specified field. Will crash if the <code>NS:Key</code> is not found.</li>
<li><code>get(Namespace :: any(), Key :: any(), Default :: any(), t())</code> - Returns a value of a specified field or <code>Default</code> if <code>NS:Key</code> is not found.</li>
<li><code>delete(Namespace :: any(), Key :: any(), t())</code> - Removes a specified field, no matter if it is permanent or not.</li>
</ul>
<h3 id="stripping">Stripping</h3>
<p>Accumulator is used mostly to cache values for reuse within a c2s process; when it goes out to somewhere else, it is stripped of all unnecessary attributes except for:</p>
<ul>
<li><code>ref</code></li>
<li><code>timestamp</code></li>
<li><code>origin_pid</code></li>
<li><code>origin_location</code></li>
<li><code>origin_stanza</code></li>
<li><code>non_strippable</code> - A set of permanent <code>NS:Key</code> pairs.</li>
</ul>
<p>If you want it to carry some additional values along with it, please use a dedicated api for setting "permanent" fields:</p>
<pre><code>Acc2 = mongoose_acc:set_permanent(myns, myprop, 123, Acc1),
</code></pre>
<p>Permanent fields may be retrieved with ordinary <code>get/3,4</code> functions.</p>
<p>The rationale behind stripping an accumulator is that some values stored in it are context-dependend.
For example, at the beginning <code>lserver</code> refers to the host of the sender C2S.
When an accumulator goes to the c2s of the recipient, the <code>lserver</code> attribute may change.
There are also many cached values which are not valid anymore when user changes (e.g. privacy checks).</p>
<p>In order to strip an accumulator, please use <code>strip(strip_params(), t())</code>, where <code>strip_params()</code> is a map of:</p>
<ul>
<li><code>lserver</code> - New host context. Obviously, may be equal to the old value.</li>
<li><code>element</code>, <code>from_jid</code>, <code>to_jid</code> - The same rules apply as in <code>update_stanza/2</code>.</li>
</ul>
<h2 id="main-principles-of-an-accumulator-processing">Main principles of an accumulator processing</h2>
<ol>
<li>An accumulator is created when a stanza enters the server.</li>
<li>An XML stanza is never passed around as a pure <code>exml:element()</code>.</li>
<li>An accumulator is stripped when it is passed to a different context (e.g. another c2s process).</li>
<li>If a process produces more stanzas to be routed, they must reuse original acc but with stanza replaced with <code>update_stanza/2</code>.</li>
</ol>
<h2 id="hooks">Hooks</h2>
<p>Many of the MongooseIM functionalities are implemented in submodules which attach their handlers to hooks (this is covered in detail in <a href="../Hooks-and-handlers/">"Hooks and handlers"</a>.
When it comes to the accumulators, the following rules apply:</p>
<ul>
<li>If a hook is related to stanza processing and is executed with <code>run_fold</code>, a Mongoose accumulator should be provided. A hook handler may modify an accumulator in every permitted way (i.e. shouldn't directly modify acc fields, bypassing <code>mongoose_acc</code> API) and should return the execution result in the <code>hook:result</code> field. This is not enforced but should be followed by convention.</li>
<li>Avoid passing superfluous arguments to handlers - e.g. an <code>LServer</code> in hook args is redundant since it is already present in the accumulator.</li>
<li>Do not use <code>run</code> - it is still present in API but executes <code>run_fold</code> with <code>ok</code> as an initial accumulator anyway.
 Handlers have been rewritten so that they accept an acc as the first arg.
 Note that <code>run</code> is deprecated now and at some point will be removed.</li>
</ul>
<p>Most handlers have already been modified so that they accept an instance of <code>mongoose_acc:t()</code> as the first argument and return value by storing it inside it.
How the accumulator is used within a module is up to the implementors of the module.</p>
<h2 id="iqs-and-accumulators">IQs and accumulators</h2>
<p><code>mongoose_iq</code> module exposes a dedicated API for accessing IQ-related accumulator fields. These are:</p>
<ul>
<li><code>info(Acc)</code> - Returns a <code>#iq{}</code> record produced from a stanza stored in the accumulator. May be <code>invalid</code> or <code>not_iq</code> if the stanza is not a valid IQ.</li>
<li><code>xmlns(Acc)</code> - Returns XMLNS of the first subelement inside an IQ. In most cases it is a namespace of <code>&lt;query/&gt;</code> subelement. May be <code>undefined</code>.</li>
<li><code>command(Acc)</code> - Returns the name of a first subelement inside an IQ. May be <code>undefined</code>.</li>
</ul>
<p>These functions ensure that cached information matches the accumulator's stanza, so all of them return a tuple with a possibly updated acc as a second element.</p>
<h2 id="sample-usage-actual-and-potential">Sample usage, actual and potential</h2>
<h3 id="privacy-check">Privacy check</h3>
<p>Stanzas are often checked against privacy lists.
According to the current <code>mongoose_privacy:privacy_check_packet</code> implementation, the result is stored in an accumulator so if a check has to be repeated it is just one map read.</p>
<h3 id="tracing">Tracing</h3>
<p><code>origin_stanza</code> field is fully immutable for the lifespan of a single accumulator, so it's easier to correlate one of the stanzas sent by a client with some "unexpected" stanza routed from a completely different part of a server.
There are many places in the server, where an accumulator may be created, so <code>origin_location</code> makes it much easier to find out what event has triggered the processing.</p>
<h3 id="performance-measurement">Performance measurement</h3>
<p>Given that each accumulator has a timestamp denoting its creation time, it is now very easy to implement a metric showing the stanza processing time, or even multiple metrics splitting it into stages.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../flat_options/" class="btn btn-neutral float-right" title="Flat options format">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../message_routing/" class="btn btn-neutral" title="Stanza routing"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../message_routing/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../flat_options/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
