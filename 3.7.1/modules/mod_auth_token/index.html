<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  
  <link rel="shortcut icon" href="../../favicon.ico">
  
  <title>mod_auth_token - MongooseIM</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700" />

  <link rel="stylesheet" href="../../css/theme.css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css" />
  <link href="../../custom.css" rel="stylesheet" />
  
  <script>
    // Current page data
    var mkdocs_page_name = "mod_auth_token";
    var mkdocs_page_input_path = "modules/mod_auth_token.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
    <div class="wy-side-scroll">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> MongooseIM</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../..">Home</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">User guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Get-to-know-MongooseIM/">ABCs of MongooseIM</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/MongooseIM-High-level-Architecture/">High-level Architecture</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Features-and-supported-standards/">Features and supported standards</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Getting-started/">Getting started</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/release_config/">Release/Installation configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Bootstrap-Scripts/">Bootstrap scripts</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Tutorials</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/How-to-build/">How to Build MongooseIM from source code</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/push-notifications/Push-notifications/">How to Set up Push Notifications</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/push-notifications/Push-notifications-client-side/">How to Set up Push Notifications on the client side</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/push-notifications/With-MongoosePush/">How to Set up MongoosePush</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/ICE_tutorial/">How to Set up MongooseICE</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/iOS_tutorial/">How to Build an iOS messaging app</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../user-guide/Jingle-SIP-setup/">How to Set up Jingle/SIP</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Migration Guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/3.1.1_3.2.0/">3.1.1 to 3.2.0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/3.3.0_3.4.0/">3.3.0 to 3.4.0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/3.5.0_3.6.0/">3.5.0 to 3.6.0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/3.6.0_3.7.0/">3.6.0 to 3.7.0</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../migrations/jid-from-mam-muc-script/">MAM MUC migration helper</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Platform</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../Contributions/">Contributions to ecosystem</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Differentiators/">Differentiators</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../History/">History</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Configuration</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../Basic-configuration/">Basic Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Erlang-cookie-security/">Erlang Cookie Security</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../Advanced-configuration/">Advanced Configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/TLS-hardening/">TLS hardening</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/database-backends-configuration/">Database backends configuration</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/outgoing-connections/">Outgoing connections</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/Modules/">Extension Modules</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/Listener-modules/">Listener Modules</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/acl/">ACL</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../advanced-configuration/Services/">Services</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Authentication methods</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-methods/client-certificate/">Client Certificate</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Authentication backends</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/External-authentication-module/">External Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/HTTP-authentication-module/">HTTP Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/JWT-authentication-module/">JWT Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/LDAP-authentication-module/">LDAP Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/PKI-authentication-module/">PKI Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/Riak-authentication-module/">Riak Authentication Module</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../authentication-backends/Dummy-authentication-module/">Dummy Authentication Module</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">MongooseIM open XMPP extensions</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../open-extensions/muc_light/">MUC light</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../open-extensions/token-reconnection/">Token-based reconnection</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">REST API</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../rest-api/Client-frontend/">Client/frontend</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../rest-api/Metrics-backend/">Metrics backend</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../rest-api/Administration-backend/">Administration backend</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Operation and maintenance</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/gdpr-considerations/">GDPR considerations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Cluster-management-considerations/">Cluster management considerations</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Cluster-configuration-and-node-management/">Cluster configuration and node management</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Logging-%26-monitoring/">Logging & monitoring</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Reloading-configuration-on-a-running-system/">Reloading configuration on a running system</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/Mongoose-metrics/">Metrics</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/System-Metrics-Privacy-Policy/">System Metrics Privacy Policy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/tls-distribution/">Distribution over TLS</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../operation-and-maintenance/known-issues/">Known issues</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Developer's guide</span></p>
                <ul>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/Testing-MongooseIM/">Testing MongooseIM</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/logging/">Logging</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/Hooks-and-handlers/">Hooks and Handlers</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/hooks_description/">Hooks description</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/message_routing/">Stanza routing</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/accumulators/">Accumulators</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/flat_options/">Flat options format</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/Moving-to-single-app-project-structure/">Moving to single app project structure</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/mod_amp_developers_guide/">mod_amp development</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/mod_muc_light_developers_guide/">mod_muc_light developers doc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/SCRAM-serialization/">SCRAM serialization format</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/xep_tool/">xep-tool usage</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/OpenSSL-and-FIPS/">FIPS mode</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/Basic-iq-handler/">Basic IQ Handler</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../../developers-guide/mongoose_wpool/">mongoose_wpool</a>
                    </li>
                </ul>
                <p class="caption"><span class="caption-text">Module index</span></p>
                <ul class="current">
                    <li class="toctree-l1"><a class="reference internal" href="../mod_adhoc/">mod_adhoc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_amp/">mod_amp</a>
                    </li>
                    <li class="toctree-l1 current"><a class="reference internal current" href="./">mod_auth_token</a>
    <ul class="current">
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_blocking/">mod_blocking</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_bosh/">mod_bosh</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_caps/">mod_caps</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_carboncopy/">mod_carboncopy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_commands/">mod_commands</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_csi/">mod_csi</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_inbox/">mod_inbox</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_disco/">mod_disco</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_global_distrib/">mod_global_distrib</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="#">mod_event_pusher</a>
    <ul>
                <li class="toctree-l2"><a class="reference internal" href="../mod_event_pusher/">mod_event_pusher</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mod_event_pusher_http/">HTTP backend</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mod_event_pusher_push/">Push backend</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mod_event_pusher_sns/">SNS backend</a>
                </li>
                <li class="toctree-l2"><a class="reference internal" href="../mod_event_pusher_rabbit/">RabbitMQ backend</a>
                </li>
    </ul>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_http_upload/">mod_http_upload</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_jingle_sip/">mod_jingle_sip</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_keystore/">mod_keystore</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_last/">mod_last</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_mam/">mod_mam</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_muc/">mod_muc</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_muc_commands/">mod_muc_commands</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_muc_log/">mod_muc_log</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_muc_light/">mod_muc_light</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_muc_light_commands/">mod_muc_light_commands</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_offline/">mod_offline</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_offline_stub/">mod_offline_stub</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_ping/">mod_ping</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_privacy/">mod_privacy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_private/">mod_private</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_pubsub/">mod_pubsub</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_push_service_mongoosepush/">mod_push_service_mongoosepush</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_register/">mod_register</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_revproxy/">mod_revproxy</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_roster/">mod_roster</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_shared_roster_ldap/">mod_shared_roster_ldap</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_sic/">mod_sic</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_stream_management/">mod_stream_management</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_time/">mod_time</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_vcard/">mod_vcard</a>
                    </li>
                    <li class="toctree-l1"><a class="reference internal" href="../mod_version/">mod_version</a>
                    </li>
                </ul>
      </div>
    </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">MongooseIM</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>Module index &raquo;</li>
        
      
    
    <li>mod_auth_token</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h3 id="module-description">Module Description</h3>
<p>This module implements handling of tokens in an OAuth-like authentication scheme. 
It provides services necessary to:</p>
<ul>
<li>deserialize/serialize binary tokens received and issued by the server,</li>
<li>validate incoming binary tokens, i.e.:<ul>
<li>check integrity using Message Authentication Codes (MAC) with server-side stored user keys,</li>
<li>check validity against the configured validity duration times,</li>
<li>check revocation status,</li>
</ul>
</li>
<li>handle token requests from logged in users.</li>
</ul>
<p>The module itself does not implement protocol related details - these are implemented in <code>cyrsasl.erl</code>.
Generation of keys necessary to sign binary tokens is delegated to module <code>mod_keystore.erl</code>.</p>
<h3 id="options">Options</h3>
<h4 id="validity-periods">Validity periods</h4>
<p>Validity periods of access and refresh tokens can be defined independently.</p>
<p>Allowed units are:</p>
<ul>
<li>days</li>
<li>hours</li>
<li>minutes</li>
<li>seconds</li>
</ul>
<p>The default values for tokens are:</p>
<ul>
<li>1 hour for an access token</li>
<li>25 days for a refresh token</li>
</ul>
<p>Example configuration from <code>mongooseim.cfg</code>, inside <code>modules</code> section:</p>
<pre><code class="language-erlang">{modules, [
    {mod_auth_token, [{{validity_period, access}, {13, minutes}},
                      {{validity_period, refresh}, {13, days}}]
]}.
</code></pre>
<p>Validity period configuration for provision tokens happens outside the module since the server does not generate provision tokens - it only validates them.</p>
<h4 id="required-keys">Required keys</h4>
<p>Keys are used for signing binary tokens using an HMAC with SHA-2 family function SHA-384.
Therefore, <code>mod_auth_token</code> requires <code>mod_keystore</code> to provide some predefined keys.</p>
<p>The required keys are (example from <code>mongooseim.cfg</code>):</p>
<pre><code class="language-erlang">{mod_keystore, [{keys, [{token_secret, ram},
                        {provision_pre_shared, {file, &quot;priv/provision_pre_shared.key&quot;}}]}]}
</code></pre>
<p><code>token_secret</code> is a RAM-only (i.e. generated on cluster startup, never written to disk) key used for signing and verifying access and refresh tokens.</p>
<p><code>provision_pre_shared</code> is a key read from a file.
As its name suggests, it's shared with a service issuing provision tokens.
Clients then use these provision tokens to authenticate with MongooseIM.</p>
<p>While it's not enforced by the server and left completely to the operator, <code>provision_pre_shared</code> keys probably should not be shared between virtual XMPP domains hosted by the server.
That is, make sure the module configuration specifying a <code>provision_pre_shared</code> key is specific to an XMPP domain.</p>
<p>MongooseIM can't generate provision tokens on its own (neither can it distribute them to clients), so while configuring a <code>provision_pre_shared</code> key to be RAM-only is technically possible, it would in practice disable the provision token support (as no external service could generate a valid token with this particular RAM key).</p>
<h3 id="token-types">Token types</h3>
<p>Three token types are supported:</p>
<ul>
<li>
<p><em>access tokens</em>: These are short lived tokens which grants aren't tracked by the server (i.e. there's no need to store anything in a database).
  Access tokens can be used as a payload for the X-OAUTH authentication mechanism and grant access to the system.
  Access tokens can't be revoked.
  An access token is valid only until its expiry date is reached.</p>
</li>
<li>
<p><em>refresh tokens</em>: These are longer lived tokens which are tracked by the server and therefore require persistent storage (as of now only PostgreSQL is supported).
  Refresh tokens can be used as a payload for the X-OAUTH authentication mechanism and to grant access to the system.
  Also they can result in a new set of tokens being returned upon successful authentication.
  They can be revoked - if a refresh token hasn't been revoked, it is valid until it has expired.
  On revocation, it immediately becomes invalid.
  As the server stores information about granted tokens, it can also persistently mark them as revoked.</p>
</li>
<li>
<p><em>provision tokens</em>: These tokens are generated by a service external to the server. 
   They grant the owner a permission to create an account.
  A provision token may contain information which the server can use to provision the VCard for the newly created account.
  Using a provision token to create an account (and inject VCard data) is done similarly to other token types, i.e. by passing it as payload for the X-OAUTH mechanism.
  The XMPP server has no way of tracking and revoking provision tokens, as they come from an outside source.</p>
</li>
</ul>
<h3 id="token-serialization-format">Token serialization format</h3>
<p>All tokens (access, refresh, provision) are to be exchanged as <em>Base64 encoded</em> binary data.
Serialization format of the token before encoding with Base64 is dependent on its type:</p>
<pre><code>'access' \0 &lt;BARE_JID&gt; \0 &lt;EXPIRES_AT&gt; \0 &lt;MAC&gt;

'refresh' \0 &lt;BARE_JID&gt; \0 &lt;EXPIRES_AT&gt; \0 &lt;SEQUENCE_NO&gt; \0 &lt;MAC&gt;

'provision' \0 &lt;BARE_JID&gt; \0 &lt;EXPIRES_AT&gt; \0 &lt;VCARD&gt; \0 &lt;MAC&gt;
</code></pre>
<p>For example (these tokens are randomly generated, hence field values don't make much sense - line breaks are inserted only for the sake of formatting,<code>&lt;vCard/&gt;</code> inner XML is snipped):</p>
<pre><code>'access' \0 Q8@localhost \0 64875466454
    \0 0acd0a66d06934791d046060cf9f1ad3c2abb3274cc7e7d7b2bc7e2ac4453ed774b6c6813b40ebec2bbc3774d59d4087

'refresh' \0 qp@localhost \0 64875466457 \0 6
    \0 8f57cb019cd6dc6e7779be165b9558611baf71ee4a40d03e77b78b069f482f96c9d23b1ac1ef69f64c1a1db3d36a96ad

'provision' \0 Xmi4@localhost \0 64875466458 \0 &lt;vCard&gt;...&lt;/vCard&gt;
    \0 86cd344c98b345390c1961e12cd4005659b4b0b3c7ec475bde9acc9d47eec27e8ddc67003696af582747fb52e578a715
</code></pre>
<h3 id="requesting-access-or-refresh-tokens-when-logged-in">Requesting access or refresh tokens when logged in</h3>
<pre><code class="language-xml">&lt;iq type='get' to='john@localhost' id='123'&gt;
    &lt;query xmlns='erlang-solutions.com:xmpp:token-auth:0'/&gt;
&lt;/iq&gt;
</code></pre>
<p>To request access and refresh tokens for the first time a client should send an IQ stanza after they have successfully authenticated for the first time using some other method.</p>
<h3 id="token-response-format">Token response format</h3>
<p>Requested tokens are being returned by the server wrapped in IQ stanza with the following fields:</p>
<ul>
<li><code>id</code>: value taken from the request IQ stanza</li>
<li><code>type</code>: result</li>
<li><code>from</code>: bare user JID</li>
<li><code>to</code>: full user JID</li>
</ul>
<p>Example response (encoded tokens have been truncated in this example):</p>
<pre><code class="language-xml">&lt;iq  id='123' type='result' from='john@localhost' to='john@localhost/res1'&gt;
    &lt;items xmlns='erlang-solutions.com:xmpp:token-auth:0'&gt;
        &lt;access_token&gt;cmVmcmVzaAGQ1Mzk1MmZlYzhkYjhlOTQzM2UxMw==&lt;/access_token&gt;
        &lt;refresh_token&gt;cmVmcmVzaAGQ1Mzk1MmZlYzhkYjhlOTQzM2UxMw==&lt;/refresh_token&gt;
    &lt;/items&gt;
&lt;/iq&gt;
</code></pre>
<p>Once a client has obtained a token, they may start authenticating using the <code>X-OAUTH</code> SASL mechanism when reaching the authentication phase of an XMPP connection initiation.</p>
<h3 id="login-with-access-or-refresh-token">Login with access or refresh token</h3>
<p>In order to log into the XMPP server using a previously requested token, a client should send the following stanza:</p>
<pre><code class="language-xml">&lt;auth xmlns=&quot;urn:ietf:params:xml:ns:xmpp-sasl&quot; mechanism=&quot;X-OAUTH&quot;&gt;
cmVmcmVzaAGQ1Mzk1MmZlYzhkYjhlOTQzM2UxMw== 
&lt;/auth&gt;
</code></pre>
<p>The Base64 encoded content is a token obtained prior to authentication.
Authentication will succeed unless the used tokens are expired, revoked, or the keys required for MAC verification could not be found by the server.</p>
<p><strong>When using a refresh token to authenticate with the server</strong>, the server will respond with a new <em>access token</em>:</p>
<pre><code class="language-xml">&lt;success xmlns=&quot;urn:ietf:params:xml:ns:xmpp-sasl&quot;&gt;
cmVmcmVzaAGQ1Mzk1MmZlYzhkYjhlOTQzM2UxMw==
&lt;/success&gt;
</code></pre>
<p>The above response is to be expected unless the refresh token used is expired or there were some problems processing the key on the server side.</p>
<h3 id="token-revocation-using-command-line-tool">Token revocation using command line tool</h3>
<p>Refresh tokens issued by the server can be used to:</p>
<ul>
<li>log in a user: as an authentication valet,</li>
<li>request <em>a new access token</em> with refreshed expiry date.</li>
</ul>
<p>An administrator may <em>revoke</em> a refresh token:</p>
<pre><code class="language-sh">mongooseimctl revoke_token owner@xmpphost
</code></pre>
<p>A client can no longer use a revoked token either for authentication or requesting new access tokens.
After a client's token has been revoked, in order to obtain a new refresh token a client has to log in using some other method.</p>
<p><strong>Caveat:</strong> as of now, the user's session is not terminated automatically on token revocation.
Therefore, the user might request a new set of tokens for as long as the session is active, even though their previous token was just revoked (possibly due to a breach / token leak).
Moreover, an access token still kept on a compromised device can be used to establish a new session for as long as it's valid - access tokens can't be revoked.
To alleviate rerequesting tokens by the user, an operator can use <code>mod_admin</code> extension allowing to terminate the user's connection.
Access token validity can't be sidestepped right now.</p>
<h3 id="example-configuration">Example configuration</h3>
<pre><code class="language-erlang">{modules, [
    {mod_auth_token, [{{validity_period, access}, {13, minutes}},
                      {{validity_period, refresh}, {13, days}}]
]}.
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../mod_blocking/" class="btn btn-neutral float-right" title="mod_blocking">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../mod_amp/" class="btn btn-neutral" title="mod_amp"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="https://www.mkdocs.org/">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../mod_amp/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../mod_blocking/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>
    <script defer>
        window.onload = function () {
            SphinxRtdTheme.Navigation.enable(true);
        };
    </script>

</body>
</html>
